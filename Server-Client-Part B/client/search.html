<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search</title>

    <!-- Bootstrap CSS -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >

    <!-- Bootstrap Icons -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
        rel="stylesheet"
    >

    <style>
        body {
            background: linear-gradient(135deg, #4e54c8, #8f94fb);
            min-height: 100vh;
        }

        .page-container {
            max-width: 1200px;
            margin: 20px auto;
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
        }

        .video-thumb {
            width: 120px;
            height: 70px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
        }

        .title-truncate {
            max-width: 320px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }
    </style>
</head>

<body>

<!-- Header -->
<nav class="navbar navbar-light bg-light px-4">
    <span class="navbar-brand fw-bold">
        <i class="bi bi-music-note-list me-2"></i>Playlist App
    </span>

    <div class="d-flex align-items-center gap-2">
        <a href="playlists.html" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-collection-play"></i> Playlists
        </a>

        <img id="headerUserImage" class="rounded-circle ms-2" width="45" height="45">
        <strong id="headerUsername"></strong>
    </div>
</nav>

<div class="page-container">

    <!-- Welcome -->
    <div class="panel shadow-sm mb-3">
        <h4>Welcome, <span id="welcomeName"></span></h4>
        <p class="text-muted mb-0">Search videos and add them to your playlists.</p>
    </div>

    <!-- Search -->
    <div class="panel shadow mb-3">
        <div class="row g-2">
            <div class="col-md-9">
                <input id="searchInput" class="form-control form-control-lg" placeholder="Search on YouTube">
            </div>
            <div class="col-md-3 d-grid">
                <button id="searchBtn" class="btn btn-primary btn-lg">
                    <i class="bi bi-search me-1"></i>Search
                </button>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="panel shadow">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Thumbnail</th>
                        <th>Title</th>
                        <th>Duration</th>
                        <th>Views</th>
                        <th>Channel</th>
                        <th class="text-end">Favorites</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            Search something to see results.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Play Modal -->
<div class="modal fade" id="playModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="playModalTitle" class="modal-title"></h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <iframe id="playFrame" class="w-100" style="aspect-ratio:16/9;" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Playlist Modal -->
<div class="modal fade" id="playlistModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add to Playlist</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <p id="selectedVideoInfo" class="text-muted"></p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Existing playlist</label>
                        <select id="playlistSelect" class="form-select"></select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">New playlist</label>
                        <input id="newPlaylistName" class="form-control">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="confirmAddBtn" class="btn btn-success">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055">
    <div id="appToast" class="toast">
        <div class="toast-header">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong class="me-auto">Playlist App</strong>
            <button class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div id="toastBody" class="toast-body"></div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Auth (must include authFetch + currentUser) -->
<script src="auth.js"></script>

<script>
requireAuth();
renderUserHeader();

document.getElementById("welcomeName").textContent = currentUser.fullName;

const YT_API_KEY = "AIzaSyDzeHuc2g_io6_4t8iZknPYuqwZuD8qxV4";

const resultsBody = document.getElementById("resultsBody");
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");

const playModal = new bootstrap.Modal(document.getElementById("playModal"));
const playFrame = document.getElementById("playFrame");
const playModalTitle = document.getElementById("playModalTitle");

const playlistModal = new bootstrap.Modal(document.getElementById("playlistModal"));
const playlistSelect = document.getElementById("playlistSelect");
const newPlaylistName = document.getElementById("newPlaylistName");
const confirmAddBtn = document.getElementById("confirmAddBtn");
const selectedVideoInfo = document.getElementById("selectedVideoInfo");

const toast = new bootstrap.Toast(document.getElementById("appToast"));
const toastBody = document.getElementById("toastBody");

let currentVideos = [];
let selectedVideo = null;

/* ============================
   SERVER PLAYLISTS (NO LOCAL)
   ============================ */

let playlistsCache = []; // [{ name, videos: [...] }, ...]

async function refreshPlaylistsCache() {
    const res = await authFetch("http://localhost:3000/api/playlists");
    if (!res.ok) {
        const err = await safeJson(res);
        console.error(err);
        throw new Error(err?.error || "Failed to load playlists");
    }
    playlistsCache = await res.json();
}

function isVideoInAnyPlaylist(videoId) {
    return playlistsCache.some(pl => pl.videos.some(v => v.videoId === videoId));
}

function showToastWithLink(playlistName) {
    toastBody.innerHTML = `
        Saved to <strong>${playlistName}</strong><br>
        <a href="playlists.html?playlist=${encodeURIComponent(playlistName)}">
            Go to playlist
        </a>
    `;
    toast.show();
}

async function ensurePlaylistExists(name) {
    if (playlistsCache.some(p => p.name === name)) return;

    const res = await authFetch("http://localhost:3000/api/playlists", {
        method: "POST",
        body: JSON.stringify({ name })
    });

    if (!res.ok) {
        const err = await safeJson(res);
        throw new Error(err?.error || "Failed to create playlist");
    }

    await refreshPlaylistsCache();
}

async function addVideoToPlaylist(name, video) {
    const res = await authFetch(`http://localhost:3000/api/playlists/${encodeURIComponent(name)}/videos`, {
        method: "POST",
        body: JSON.stringify(video)
    });

    if (!res.ok) {
        const err = await safeJson(res);
        throw new Error(err?.error || "Failed to add video");
    }

    await refreshPlaylistsCache();
}

/* helpers */
async function safeJson(res) {
    try { return await res.json(); } catch { return null; }
}

/* ============================
   FORMATTING (FROM ORIGINAL)
   ============================ */

function formatDuration(isoDuration) {
    const match = isoDuration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    const hours = parseInt(match?.[1] || 0);
    const minutes = parseInt(match?.[2] || 0);
    const seconds = parseInt(match?.[3] || 0);

    if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }
    return `${minutes}:${String(seconds).padStart(2, "0")}`;
}

function formatViews(views) {
    const num = Number(views);

    if (num >= 1_000_000_000) return (num / 1_000_000_000).toFixed(1).replace(".0", "") + "B";
    if (num >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(".0", "") + "M";
    if (num >= 1_000) return (num / 1_000).toFixed(1).replace(".0", "") + "K";

    return num.toString();
}

/* ============================
   UI RENDER (FROM ORIGINAL)
   ============================ */

function renderResults(videos) {
    currentVideos = videos;
    resultsBody.innerHTML = "";

    videos.forEach(v => {
        const added = isVideoInAnyPlaylist(v.videoId);

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>
                <img class="video-thumb" src="${v.thumbnail}" data-id="${v.videoId}">
                ${added ? '<div class="badge bg-success mt-1"><i class="bi bi-check-lg"></i> In Favorites</div>' : ''}
            </td>
            <td>
                <span class="title-truncate" title="${v.title}">${v.title}</span>
            </td>
            <td>${v.duration}</td>
            <td>${v.views}</td>
            <td>${v.channel}</td>
            <td class="text-end">
                <button class="btn btn-sm ${added ? 'btn-secondary' : 'btn-success'}"
                    ${added ? 'disabled' : ''}
                    data-add="${v.videoId}">
                    ${added ? '<i class="bi bi-check-circle-fill"></i> Added'
                             : '<i class="bi bi-bookmark-plus"></i> Add'}
                </button>
            </td>
        `;

        // play on thumbnail click
        tr.querySelector("img").onclick = () => {
            playModalTitle.textContent = v.title;
            playFrame.src = `https://www.youtube.com/embed/${v.videoId}?autoplay=1`;
            playModal.show();
        };

        // play on title click
        const titleSpan = tr.querySelector(".title-truncate");
        titleSpan.style.cursor = "pointer";
        titleSpan.onclick = () => {
            playModalTitle.textContent = v.title;
            playFrame.src = `https://www.youtube.com/embed/${v.videoId}?autoplay=1`;
            playModal.show();
        };

        const addBtn = tr.querySelector("[data-add]");
        if (addBtn) addBtn.onclick = () => openPlaylistModal(v);

        resultsBody.appendChild(tr);

        // Tooltip only if title is truncated
        if (titleSpan.scrollWidth > titleSpan.clientWidth) {
            titleSpan.setAttribute("data-bs-toggle", "tooltip");
            titleSpan.setAttribute("data-bs-placement", "top");
            new bootstrap.Tooltip(titleSpan);
        }
    });
}

function openPlaylistModal(video) {
    selectedVideo = video;
    selectedVideoInfo.textContent = video.title;

    playlistSelect.innerHTML = '<option value="">Select playlist</option>';
    playlistsCache.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.name;
        opt.textContent = p.name;
        playlistSelect.appendChild(opt);
    });

    newPlaylistName.value = "";
    playlistModal.show();
}

/* ============================
   ADD BUTTON (SERVER VERSION)
   ============================ */

confirmAddBtn.onclick = async () => {
    const existing = playlistSelect.value;
    const newName = newPlaylistName.value.trim();
    const name = existing || newName;
    if (!name) return;

    try {
        await ensurePlaylistExists(name);
        await addVideoToPlaylist(name, selectedVideo);

        showToastWithLink(name);
        playlistModal.hide();
        renderResults(currentVideos);
    } catch (e) {
        alert(e?.message || "Failed to add video");
    }
};

/* ============================
   YOUTUBE SEARCH (FROM ORIGINAL)
   ============================ */

async function search(query) {
    const searchRes = await fetch(
        `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=8&q=${encodeURIComponent(query)}&key=${YT_API_KEY}`
    );
    const searchJson = await searchRes.json();

    if (!searchRes.ok) {
        console.error(searchJson);
        alert(searchJson?.error?.message || "YouTube search failed");
        return;
    }

    const ids = (searchJson.items || [])
        .map(i => i.id && i.id.videoId)
        .filter(Boolean)
        .join(",");

    if (!ids) {
        resultsBody.innerHTML = `
            <tr><td colspan="6" class="text-center text-muted py-4">No results.</td></tr>
        `;
        return;
    }

    const detailsRes = await fetch(
        `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${ids}&key=${YT_API_KEY}`
    );
    const detailsJson = await detailsRes.json();

    if (!detailsRes.ok) {
        console.error(detailsJson);
        alert(detailsJson?.error?.message || "YouTube details failed");
        return;
    }

    const videos = searchJson.items.map(item => {
        const vid = item.id.videoId;
        const d = (detailsJson.items || []).find(x => x.id === vid);

        return {
            videoId: vid,
            title: item.snippet.title,
            channel: item.snippet.channelTitle,
            thumbnail: item.snippet.thumbnails.medium.url,
            duration: d ? formatDuration(d.contentDetails.duration) : "-",
            views: d ? formatViews(d.statistics.viewCount) : "0"
        };
    });

    renderResults(videos);
}

searchBtn.onclick = () => {
    const q = searchInput.value.trim();
    if (!q) return;
    history.pushState({}, "", `?query=${encodeURIComponent(q)}`);
    search(q);
};

/* auto-search from query string */
const params = new URLSearchParams(location.search);
if (params.get("query")) {
    searchInput.value = params.get("query");
}

/* INIT */
(async function init() {
    try {
        await refreshPlaylistsCache();

        if (params.get("query")) {
            await search(params.get("query"));
        }
    } catch (e) {
        console.error(e);
        alert(e?.message || "Failed to initialize");
    }
})();
</script>

</body>
</html>
